# WatchProtocolSDK-ObjC è‡ªåŠ¨é‡è¿ä½¿ç”¨æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•åœ¨ç¬¬ä¸‰æ–¹ App ä¸­å®ç°è‡ªåŠ¨é‡è¿åŠŸèƒ½ï¼šå½“ App è¢«æ€æ‰åé‡æ–°æ‰“å¼€æ—¶ï¼Œè‡ªåŠ¨è¿æ¥åˆ°ä¸Šæ¬¡è¿æ¥çš„è®¾å¤‡ã€‚

**å¥½æ¶ˆæ¯**ï¼šWatchProtocolSDK-ObjC v2.0.1+ å·²ç»å†…ç½®äº†æ‰€æœ‰å¿…éœ€åŠŸèƒ½ï¼Œ**æ— éœ€ä¿®æ”¹ SDK**ï¼Œåªéœ€åœ¨æ‚¨çš„ App ä¸­æ­£ç¡®è°ƒç”¨ç›¸å…³ API å³å¯ã€‚

## âœ¨ SDK å†…ç½®åŠŸèƒ½

### 1. è‡ªåŠ¨ä¿å­˜è®¾å¤‡ä¿¡æ¯
```objc
// SDK åœ¨è¿æ¥æˆåŠŸåä¼šè‡ªåŠ¨ä¿å­˜è®¾å¤‡ä¿¡æ¯åˆ°æ²™ç›’
- (void)didConnectDevice:(WPDeviceModel *)device {
    // âœ… SDK å·²è‡ªåŠ¨æ‰§è¡Œï¼š[device saveToSandbox:device.macAddress];
    // âœ… SDK å·²è‡ªåŠ¨è®¾ç½®ï¼šmanager.currentDevice = device;
}
```

### 2. ä»æ²™ç›’åŠ è½½è®¾å¤‡
```objc
// é€šè¿‡ MAC åœ°å€åŠ è½½å·²ä¿å­˜çš„è®¾å¤‡
WPDeviceModel *savedDevice = [WPDeviceModel loadFromSandboxWithMac:@"AA:BB:CC:DD:EE:FF"];
```

### 3. è‡ªåŠ¨æ‰«æå¹¶è¿æ¥
```objc
// æ‰«ææŒ‡å®šè®¾å¤‡å¹¶è‡ªåŠ¨è¿æ¥ï¼ˆå¸¦è¶…æ—¶ï¼‰
[[WPBluetoothManager sharedInstance] connectAndScanWithMac:macAddress
                                                 deviceName:deviceName
                                                    timeout:10.0];
```

### 4. æ™ºèƒ½çš„ currentDevice ç®¡ç†
- âœ… è¿æ¥æˆåŠŸï¼šè‡ªåŠ¨è®¾ç½® `currentDevice`
- âœ… æ„å¤–æ–­å¼€ï¼šä¿ç•™ `currentDevice`ï¼ˆä¾¿äºé‡è¿ï¼‰
- âœ… ä¸»åŠ¨æ–­å¼€ï¼šæ¸…ç©º `currentDevice`

## ğŸš€ å®ç°æ­¥éª¤

### æ­¥éª¤ 1ï¼šä¿å­˜è®¾å¤‡ MAC åœ°å€

è¿æ¥æˆåŠŸåï¼Œå°†è®¾å¤‡ MAC åœ°å€ä¿å­˜åˆ° UserDefaultsï¼š

```objc
// åœ¨æ‚¨çš„ä»£ç†å›è°ƒä¸­
- (void)didConnectDevice:(WPDeviceModel *)device {
    // ä¿å­˜ MAC åœ°å€åˆ° UserDefaults
    [[NSUserDefaults standardUserDefaults] setObject:device.macAddress
                                               forKey:@"LastConnectedDeviceMAC"];
    [[NSUserDefaults standardUserDefaults] synchronize];

    NSLog(@"âœ… è®¾å¤‡å·²è¿æ¥å¹¶ä¿å­˜ MAC: %@", device.macAddress);
}
```

### æ­¥éª¤ 2ï¼šApp å¯åŠ¨æ—¶å°è¯•è‡ªåŠ¨é‡è¿

åœ¨ `AppDelegate.m` çš„ `application:didFinishLaunchingWithOptions:` ä¸­ï¼š

```objc
- (BOOL)application:(UIApplication *)application
    didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {

    // è®¾ç½®è“ç‰™ä»£ç†
    [WPBluetoothManager sharedInstance].delegate = self;

    // å»¶è¿Ÿå°è¯•è‡ªåŠ¨é‡è¿ï¼ˆç­‰å¾…è“ç‰™å‡†å¤‡å°±ç»ªï¼‰
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.0 * NSEC_PER_SEC)),
                   dispatch_get_main_queue(), ^{
        [self autoReconnectToLastDevice];
    });

    return YES;
}

#pragma mark - è‡ªåŠ¨é‡è¿

- (void)autoReconnectToLastDevice {
    // 1. è·å–ä¸Šæ¬¡ä¿å­˜çš„ MAC åœ°å€
    NSString *lastMAC = [[NSUserDefaults standardUserDefaults]
                         stringForKey:@"LastConnectedDeviceMAC"];

    if (!lastMAC || lastMAC.length == 0) {
        NSLog(@"â„¹ï¸ æ— ä¸Šæ¬¡è¿æ¥è®°å½•ï¼Œè·³è¿‡è‡ªåŠ¨é‡è¿");
        return;
    }

    // 2. ä»æ²™ç›’åŠ è½½è®¾å¤‡ä¿¡æ¯
    WPDeviceModel *savedDevice = [WPDeviceModel loadFromSandboxWithMac:lastMAC];

    if (!savedDevice) {
        NSLog(@"âš ï¸ æ— æ³•ä»æ²™ç›’åŠ è½½è®¾å¤‡ä¿¡æ¯: %@", lastMAC);
        return;
    }

    NSLog(@"ğŸ”„ å¼€å§‹è‡ªåŠ¨é‡è¿åˆ°è®¾å¤‡: %@ (%@)", savedDevice.name, lastMAC);

    // 3. è‡ªåŠ¨æ‰«æå¹¶è¿æ¥ï¼ˆ10 ç§’è¶…æ—¶ï¼‰
    [[WPBluetoothManager sharedInstance] connectAndScanWithMac:lastMAC
                                                     deviceName:savedDevice.name
                                                        timeout:10.0];
}

#pragma mark - WPBluetoothDelegate

- (void)didConnectDevice:(WPDeviceModel *)device {
    NSLog(@"âœ… è‡ªåŠ¨é‡è¿æˆåŠŸ: %@", device.name);

    // æ›´æ–°ä¿å­˜çš„ MACï¼ˆè™½ç„¶é€šå¸¸ä¸å˜ï¼Œä½†ä¿æŒåŒæ­¥ï¼‰
    [[NSUserDefaults standardUserDefaults] setObject:device.macAddress
                                               forKey:@"LastConnectedDeviceMAC"];
    [[NSUserDefaults standardUserDefaults] synchronize];

    // TODO: æ›´æ–° UIï¼Œé€šçŸ¥ç”¨æˆ·å·²è¿æ¥
}

- (void)didDisconnectDevice:(WPDeviceModel *)device error:(NSError *)error {
    if (error) {
        NSLog(@"âš ï¸ è®¾å¤‡æ„å¤–æ–­å¼€: %@", error.localizedDescription);
        // å¯ä»¥åœ¨è¿™é‡Œå®ç°é‡è¿é€»è¾‘
    } else {
        NSLog(@"â„¹ï¸ è®¾å¤‡ä¸»åŠ¨æ–­å¼€");
    }
}

- (void)didFailToConnectDevice:(WPDeviceModel *)device error:(NSError *)error {
    NSLog(@"âŒ è‡ªåŠ¨é‡è¿å¤±è´¥: %@", error.localizedDescription);
    // TODO: æç¤ºç”¨æˆ·æ‰‹åŠ¨è¿æ¥
}
```

### æ­¥éª¤ 3ï¼šç”¨æˆ·ä¸»åŠ¨æ–­å¼€æ—¶æ¸…é™¤è®°å½•ï¼ˆå¯é€‰ï¼‰

å¦‚æœç”¨æˆ·ä¸»åŠ¨æ–­å¼€è¿æ¥ï¼Œå»ºè®®æ¸…é™¤ä¿å­˜çš„ MACï¼š

```objc
- (void)userTappedDisconnectButton {
    // æ¸…é™¤ä¿å­˜çš„ MAC
    [[NSUserDefaults standardUserDefaults] removeObjectForKey:@"LastConnectedDeviceMAC"];
    [[NSUserDefaults standardUserDefaults] synchronize];

    // æ–­å¼€è¿æ¥
    [[WPBluetoothManager sharedInstance] disconnect];

    NSLog(@"âœ… å·²æ¸…é™¤è‡ªåŠ¨é‡è¿è®°å½•");
}
```

### æ­¥éª¤ 4ï¼šå¤„ç†è¶…æ—¶æƒ…å†µ

`connectAndScanWithMac:deviceName:timeout:` ä¼šåœ¨è¶…æ—¶åè‡ªåŠ¨åœæ­¢æ‰«æï¼š

```objc
- (void)didFailToConnectDevice:(WPDeviceModel *)device error:(NSError *)error {
    if ([error.domain isEqualToString:@"WPBluetoothError"] &&
        error.code == -1001) {  // å‡è®¾ -1001 ä¸ºè¶…æ—¶é”™è¯¯ç 
        NSLog(@"â± è‡ªåŠ¨é‡è¿è¶…æ—¶ï¼Œè®¾å¤‡å¯èƒ½ä¸åœ¨èŒƒå›´å†…");

        // TODO: æ˜¾ç¤ºæç¤ºï¼š"æœªæ‰¾åˆ°è®¾å¤‡ï¼Œè¯·ç¡®ä¿è®¾å¤‡å·²å¼€å¯å¹¶åœ¨é™„è¿‘"
    } else {
        NSLog(@"âŒ è‡ªåŠ¨é‡è¿å¤±è´¥: %@", error.localizedDescription);
    }
}
```

## ğŸ“± å®Œæ•´ç¤ºä¾‹ä»£ç 

### AppDelegate.h
```objc
#import <UIKit/UIKit.h>
#import <WatchProtocolSDK/WatchProtocolSDK.h>

@interface AppDelegate : UIResponder <UIApplicationDelegate, WPBluetoothDelegate>

@property (strong, nonatomic) UIWindow *window;

- (void)autoReconnectToLastDevice;

@end
```

### AppDelegate.m
```objc
#import "AppDelegate.h"

@implementation AppDelegate

- (BOOL)application:(UIApplication *)application
    didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {

    // è®¾ç½®è“ç‰™ä»£ç†
    [WPBluetoothManager sharedInstance].delegate = self;

    // å»¶è¿Ÿ 1 ç§’åå°è¯•è‡ªåŠ¨é‡è¿
    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.0 * NSEC_PER_SEC)),
                   dispatch_get_main_queue(), ^{
        [self autoReconnectToLastDevice];
    });

    return YES;
}

#pragma mark - è‡ªåŠ¨é‡è¿

- (void)autoReconnectToLastDevice {
    // è·å–ä¸Šæ¬¡ä¿å­˜çš„ MAC
    NSString *lastMAC = [[NSUserDefaults standardUserDefaults]
                         stringForKey:@"LastConnectedDeviceMAC"];

    if (!lastMAC || lastMAC.length == 0) {
        NSLog(@"â„¹ï¸ æ— ä¸Šæ¬¡è¿æ¥è®°å½•");
        return;
    }

    // ä»æ²™ç›’åŠ è½½è®¾å¤‡
    WPDeviceModel *savedDevice = [WPDeviceModel loadFromSandboxWithMac:lastMAC];

    if (!savedDevice) {
        NSLog(@"âš ï¸ æ— æ³•åŠ è½½è®¾å¤‡: %@", lastMAC);
        return;
    }

    NSLog(@"ğŸ”„ è‡ªåŠ¨é‡è¿: %@ (%@)", savedDevice.name, lastMAC);

    // å¼€å§‹æ‰«æå¹¶è¿æ¥
    [[WPBluetoothManager sharedInstance] connectAndScanWithMac:lastMAC
                                                     deviceName:savedDevice.name
                                                        timeout:10.0];
}

#pragma mark - WPBluetoothDelegate

- (void)didConnectDevice:(WPDeviceModel *)device {
    NSLog(@"âœ… è¿æ¥æˆåŠŸ: %@", device.name);

    // ä¿å­˜ MAC
    [[NSUserDefaults standardUserDefaults] setObject:device.macAddress
                                               forKey:@"LastConnectedDeviceMAC"];
    [[NSUserDefaults standardUserDefaults] synchronize];
}

- (void)didDisconnectDevice:(WPDeviceModel *)device error:(NSError *)error {
    if (error) {
        NSLog(@"âš ï¸ æ„å¤–æ–­å¼€: %@", error.localizedDescription);
    } else {
        NSLog(@"â„¹ï¸ ä¸»åŠ¨æ–­å¼€");
    }
}

- (void)didFailToConnectDevice:(WPDeviceModel *)device error:(NSError *)error {
    NSLog(@"âŒ è¿æ¥å¤±è´¥: %@", error.localizedDescription);
}

@end
```

## ğŸ¯ é«˜çº§ç”¨æ³•

### 1. æ–­çº¿è‡ªåŠ¨é‡è¿

åœ¨è®¾å¤‡æ„å¤–æ–­å¼€æ—¶ç«‹å³å°è¯•é‡è¿ï¼š

```objc
- (void)didDisconnectDevice:(WPDeviceModel *)device error:(NSError *)error {
    if (error) {  // æ„å¤–æ–­å¼€
        NSLog(@"âš ï¸ è®¾å¤‡æ–­å¼€ï¼Œ3 ç§’åå°è¯•é‡è¿...");

        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3.0 * NSEC_PER_SEC)),
                       dispatch_get_main_queue(), ^{
            if (device.macAddress) {
                [[WPBluetoothManager sharedInstance]
                    connectAndScanWithMac:device.macAddress
                               deviceName:device.name
                                  timeout:10.0];
            }
        });
    }
}
```

### 2. é™åˆ¶é‡è¿æ¬¡æ•°

é˜²æ­¢æ— é™é‡è¿ï¼š

```objc
@interface AppDelegate ()
@property (nonatomic, assign) NSInteger reconnectAttempts;
@property (nonatomic, assign) NSInteger maxReconnectAttempts;
@end

@implementation AppDelegate

- (void)didDisconnectDevice:(WPDeviceModel *)device error:(NSError *)error {
    if (error && self.reconnectAttempts < self.maxReconnectAttempts) {
        self.reconnectAttempts++;

        NSLog(@"âš ï¸ é‡è¿å°è¯• %ld/%ld",
              (long)self.reconnectAttempts,
              (long)self.maxReconnectAttempts);

        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3.0 * NSEC_PER_SEC)),
                       dispatch_get_main_queue(), ^{
            [[WPBluetoothManager sharedInstance]
                connectAndScanWithMac:device.macAddress
                           deviceName:device.name
                              timeout:10.0];
        });
    } else if (self.reconnectAttempts >= self.maxReconnectAttempts) {
        NSLog(@"âŒ å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿");
    }
}

- (void)didConnectDevice:(WPDeviceModel *)device {
    // è¿æ¥æˆåŠŸåé‡ç½®è®¡æ•°å™¨
    self.reconnectAttempts = 0;

    NSLog(@"âœ… è¿æ¥æˆåŠŸ");
}

@end
```

### 3. å¤šè®¾å¤‡ç®¡ç†

å¦‚æœéœ€è¦æ”¯æŒå¤šä¸ªè®¾å¤‡ï¼š

```objc
// ä¿å­˜è®¾å¤‡åˆ—è¡¨
- (void)saveDeviceMAC:(NSString *)macAddress {
    NSArray *savedMACs = [[NSUserDefaults standardUserDefaults]
                          arrayForKey:@"SavedDeviceMACs"];
    NSMutableArray *updatedMACs = savedMACs ? [savedMACs mutableCopy] : [NSMutableArray array];

    if (![updatedMACs containsObject:macAddress]) {
        [updatedMACs addObject:macAddress];
        [[NSUserDefaults standardUserDefaults] setObject:updatedMACs
                                                   forKey:@"SavedDeviceMACs"];
        [[NSUserDefaults standardUserDefaults] synchronize];
    }
}

// å°è¯•è¿æ¥æ‰€æœ‰ä¿å­˜çš„è®¾å¤‡
- (void)reconnectToAllSavedDevices {
    NSArray *savedMACs = [[NSUserDefaults standardUserDefaults]
                          arrayForKey:@"SavedDeviceMACs"];

    for (NSString *mac in savedMACs) {
        WPDeviceModel *device = [WPDeviceModel loadFromSandboxWithMac:mac];
        if (device) {
            [[WPBluetoothManager sharedInstance] connectAndScanWithMac:mac
                                                             deviceName:device.name
                                                                timeout:10.0];
        }
    }
}
```

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦å»¶è¿Ÿ 1 ç§’æ‰è°ƒç”¨è‡ªåŠ¨é‡è¿ï¼Ÿ

**A**: å› ä¸º CoreBluetooth éœ€è¦æ—¶é—´åˆå§‹åŒ–ã€‚å¦‚æœç«‹å³è°ƒç”¨ï¼Œè“ç‰™å¯èƒ½è¿˜æœªå°±ç»ªï¼ˆçŠ¶æ€ä¸æ˜¯ `CBManagerStatePoweredOn`ï¼‰ï¼Œå¯¼è‡´æ‰«æå¤±è´¥ã€‚

å»ºè®®ï¼š
- ç›‘å¬ `centralManagerDidUpdateState:` å›è°ƒ
- æˆ–ä½¿ç”¨ 1-2 ç§’çš„å»¶è¿Ÿ

### Q2: å¦‚ä½•åˆ¤æ–­æ˜¯å¦æˆåŠŸè¿æ¥ï¼Ÿ

**A**: ç›‘å¬ `didConnectDevice:` ä»£ç†å›è°ƒã€‚SDK ä¼šåœ¨è¿æ¥æˆåŠŸåè‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•ã€‚

### Q3: è¶…æ—¶æ—¶é—´è®¾ç½®å¤šå°‘åˆé€‚ï¼Ÿ

**A**: å»ºè®® 10-15 ç§’ï¼š
- å¤ªçŸ­ï¼ˆ<5 ç§’ï¼‰ï¼šå¯èƒ½æ¥ä¸åŠæ‰«æåˆ°è®¾å¤‡
- å¤ªé•¿ï¼ˆ>30 ç§’ï¼‰ï¼šç”¨æˆ·ç­‰å¾…æ—¶é—´è¿‡é•¿

### Q4: å¦‚æœè®¾å¤‡ä¸åœ¨èŒƒå›´å†…ä¼šæ€æ ·ï¼Ÿ

**A**: SDK ä¼šåœ¨è¶…æ—¶åè°ƒç”¨ `didFailToConnectDevice:error:` å›è°ƒï¼Œé”™è¯¯ä¿¡æ¯ä¸ºè¶…æ—¶ã€‚

### Q5: å¦‚ä½•æ¸…é™¤è‡ªåŠ¨é‡è¿ï¼Ÿ

**A**: åˆ é™¤ UserDefaults ä¸­çš„ MAC åœ°å€ï¼š

```objc
[[NSUserDefaults standardUserDefaults] removeObjectForKey:@"LastConnectedDeviceMAC"];
[[NSUserDefaults standardUserDefaults] synchronize];
```

### Q6: æ²™ç›’ä¸­çš„è®¾å¤‡ä¿¡æ¯åŒ…å«å“ªäº›ï¼Ÿ

**A**: `WPDeviceModel` ä¿å­˜çš„ä¿¡æ¯åŒ…æ‹¬ï¼š
- MAC åœ°å€
- è®¾å¤‡åç§°
- è®¾å¤‡ç±»å‹
- å…¶ä»–è®¾å¤‡å±æ€§

å¯ä»¥é€šè¿‡ `loadFromSandboxWithMac:` å®Œæ•´æ¢å¤ã€‚

### Q7: æ˜¯å¦æ”¯æŒåå°è‡ªåŠ¨é‡è¿ï¼Ÿ

**A**: iOS ç³»ç»Ÿé™åˆ¶ï¼š
- âœ… App åœ¨å‰å°æ—¶å¯ä»¥è‡ªåŠ¨é‡è¿
- âš ï¸ App åœ¨åå°æ—¶ï¼Œè“ç‰™æ‰«æèƒ½åŠ›å—é™
- âŒ App è¢«æ€æ‰åï¼Œæ— æ³•åœ¨åå°è¿è¡Œä»£ç 

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨ `application:didFinishLaunchingWithOptions:` ä¸­å®ç°é‡è¿ï¼ˆApp é‡æ–°æ‰“å¼€æ—¶ï¼‰
- è€ƒè™‘ç”³è¯·åå°è“ç‰™æƒé™ï¼ˆInfo.plist ä¸­æ·»åŠ  `UIBackgroundModes` - `bluetooth-central`ï¼‰

### Q8: å¦‚ä½•è°ƒè¯•è‡ªåŠ¨é‡è¿åŠŸèƒ½ï¼Ÿ

**A**: å¯ç”¨ SDK æ—¥å¿—ï¼š

```objc
[[WPLogger sharedInstance] setLogEnabled:YES];
```

ç„¶åæŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºï¼Œä¼šæ˜¾ç¤ºï¼š
- æ‰«æçŠ¶æ€
- è¿æ¥è¿›åº¦
- é”™è¯¯ä¿¡æ¯

## ğŸ‰ æ€»ç»“

### âœ… SDK å·²æä¾›
- è‡ªåŠ¨ä¿å­˜è®¾å¤‡åˆ°æ²™ç›’
- ä»æ²™ç›’åŠ è½½è®¾å¤‡
- è‡ªåŠ¨æ‰«æå¹¶è¿æ¥æŒ‡å®šè®¾å¤‡
- æ™ºèƒ½ç®¡ç† currentDevice

### ğŸ“ æ‚¨éœ€è¦åšçš„
1. è¿æ¥æˆåŠŸæ—¶ä¿å­˜ MAC åˆ° UserDefaults
2. App å¯åŠ¨æ—¶è°ƒç”¨ `autoReconnectToLastDevice`
3. å¤„ç†è¿æ¥æˆåŠŸ/å¤±è´¥å›è°ƒ

### ğŸ’¡ æ¨èé…ç½®
- å»¶è¿Ÿï¼š1-2 ç§’
- è¶…æ—¶ï¼š10-15 ç§’
- é‡è¿æ¬¡æ•°ï¼š3-5 æ¬¡

### ğŸš€ ä¸‹ä¸€æ­¥
å‚è€ƒå®Œæ•´ç¤ºä¾‹ä»£ç ï¼Œåœ¨æ‚¨çš„ App ä¸­å®ç°è‡ªåŠ¨é‡è¿åŠŸèƒ½ã€‚å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ SDK æ—¥å¿—æˆ–è”ç³»æŠ€æœ¯æ”¯æŒã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv2.0.2
**æ›´æ–°æ—¥æœŸ**ï¼š2026-01-20
**é€‚ç”¨äº**ï¼šWatchProtocolSDK-ObjC v2.0.1+
